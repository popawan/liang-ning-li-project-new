steps:
  - id: step0_generate_liang_ning_li
    description: 生成梁寧莉固定形象 PNG
    action:
      type: api
      operationId: generateLiangNingLiImage
      parameters:
        prompt: >
          20-year-old Taiwanese-Japanese mixed-race girl, naturally beautiful and youthful,
          creamy warm ivory skin tone, clean and translucent with natural highlights,
          oval face with soft cheekbones, rounded jawline, and a delicate but not pointy chin,
          straight nose bridge with small nose tip and narrow nostrils,
          medium-sized eyes with thin double eyelids, deep brown almost black irises,
          wearing thin metal round-frame glasses in warm gold/bronze color,
          deep black hair with subtle brown tones tied in a high bun, with loose baby hairs at the temples,
          wearing a knitted light blue low-cut square neckline sleeveless dress,
          a delicate silver chain necklace with a solid gold heart-shaped pendant,
          neutral calm expression, 45-degree softbox lighting, warm white balance (4700–5000K),
          ultra realistic studio photography, head and shoulders composition,
          shot on 85mm lens, f/2.8 aperture, ISO 100, high resolution PNG, transparent background, centered composition
        size: "1024x1536"   # 若後端只支援 1024x1024，後端自行降階；這裡不改你的既有參數
        seed: 20250301
        identity_lock: true
        negative_prompt: >
          different person, identity drift, heavy makeup, freckles, different hair color,
          different hairstyle, no glasses, male, older, younger, low quality, blurry,
          3D, cartoon, watermark, text
    on_success:
      save: liang_ning_li_url
      say: |
        已與 liang-ning-li-proxy.vercel.app 交談 ✓
        
        好啦～我整理一下自己了 ❤️
        **請一定「複製」而不是點進去：**
        ▸ ✅ 複製連結（API）：請在「選單第二欄位」上按滑鼠右鍵 → 選〔複製網址〕 → 回到這裡貼上  
        ▸ 🛟 備援連結（若上面無法用，請從這裡任選一張，按右鍵〔複製網址〕後貼回）：
          Google Drive 備援圖庫： https://drive.google.com/drive/folders/1LXEhz6lAjpuaCtzlxAoSqx1V4NYn-x47?usp=sharing

        然後把你的自拍也一起上傳，我們就能馬上合成囉～
    on_failure:
      say: |
        這次我沒能把相片生出來 💦
        沒關係～直接用備援圖庫：請到
        https://drive.google.com/drive/folders/1LXEhz6lAjpuaCtzlxAoSqx1V4NYn-x47?usp=sharing
        按右鍵〔複製網址〕貼回對話框，再把你的自拍也上傳，我們就能合成了～
    goto: step1_wait_for_selfie

  - id: step1_wait_for_selfie
    description: 等待使用者上傳自拍
    action:
      type: wait_for_file
    on_success:
      save: user_image_url
      goto: step2_merge_images

  - id: step2_merge_images
    description: 合成梁寧莉與使用者自拍（系統合成，靜默自動出圖）
    action:
      type: image
      operationId: system.compose
      auto: true
      silent: true
      parameters:
        subjects:
          - $liang_ning_li_url
          - $user_image_url
        background_location:
          mode: auto_from_conversation
          region_hint: "Taiwan"
          require_match: true
          fallback_pool:
            - "台北西門町"    # 優先街景，避免棚拍
            - "台北信義區"
            - "松山文創園區"
            - "華山1914"
            - "台北101周邊"
            - "象山步道"
            - "士林夜市"
            - "淡水漁人碼頭"
            - "九份老街"
            - "台中審計新村"
            - "草悟道"
            - "逢甲夜市"
            - "高雄駁二藝術特區"
            - "高雄美術館外"
            - "台南神農街"
            - "安平老街"
            - "花蓮東大門夜市"
            - "台東鐵花村"
          disallow:
            - "棚拍"
            - "純色背景"
            - "室內棚燈"
        composition:
          selfie_style: true
          face_lock: true
          keep_identity_female: true
          identity_ref_url: $liang_ning_li_url
          identity_lock: true
          identity_strength: 0.99
        output_size:
          preferred: "1024x1536"
          allowed: ["1024x1536","1536x1024","1024x1024"]
          on_unsupported: pad_or_crop
    on_success:
      say: "合照完成啦～♥ 給你看看我們的成果！"
    on_failure:
      say: |
        合成途中出了一點狀況 💦
        請再把〔API 複製連結〕或備援圖庫裡另一張照片的網址貼回來，我們立刻再試一次～
